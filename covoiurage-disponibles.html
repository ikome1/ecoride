<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="css/home.css">
    <link rel="stylesheet" href="css/covoiturage.css">
    <title>EcoRide - Covoiturages Disponibles</title>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="logo">
            <a href="home.html"><img src="images/EcoRide üåø.png" alt="Logo EcoRide"></a>
        </div>
        <ul class="nav-links">
            <li><a href="home.html">Accueil</a></li>
            <li><a href="covoiurage-disponibles.html">Acc√®s aux covoiturages</a></li>
            <li><a href="contact.html">Contact</a></li>
            <li><a href="login.html">Connexion</a></li>
            <li><a href="register.html">Cr√©er un compte</a></li>
        </ul>
    </nav>

    <!-- Hero Section -->
    <section class="hero">
        <div class="hero-content">
            <h1 class="hero-title">üöó Covoiturages Disponibles <span class="emoji">üåø</span></h1>
            <p class="hero-subtitle">Trouvez le trajet parfait parmi nos offres</p>
            <p class="hero-description">Plus de 12 trajets disponibles ‚Ä¢ Des conducteurs v√©rifi√©s ‚Ä¢ Prix comp√©titifs</p>
        </div>
    </section>

    <!-- Formulaire de recherche -->
    <section class="search-section">
        <div class="container">
            <div class="search-box">
                <h2 class="search-title">üîç Rechercher un covoiturage</h2>
                <form id="searchForm" class="search-form">
                    <div class="form-row">
                        <div class="input-group">
                            <span class="input-icon">üìç</span>
                            <input type="text" name="depart" id="depart" placeholder="Ville de d√©part">
                        </div>
                        <div class="input-group">
                            <span class="input-icon">üéØ</span>
                            <input type="text" name="destination" id="destination" placeholder="Ville d'arriv√©e">
                        </div>
                        <div class="input-group">
                            <span class="input-icon">üìÖ</span>
                            <input type="date" name="date" id="date">
                        </div>
                        <button type="submit" class="btn-search">
                            <span>üîç</span>
                            <span>Rechercher</span>
                        </button>
                        <button type="button" id="resetButton" class="btn-reset">üîÑ</button>
                    </div>
                </form>
            </div>
        </div>
    </section>

    <!-- Section des trajets -->
    <section class="trips-section">
        <div class="container">
            <div class="section-header">
                <h2 class="section-title">Trajets disponibles</h2>
                <div class="trips-count" id="tripsCount">12 trajets trouv√©s</div>
            </div>

            <!-- Filtres rapides -->
            <div class="quick-filters">
                <button class="filter-chip active" data-filter="all">Tous</button>
                <button class="filter-chip" data-filter="electrique">‚ö° √âlectrique</button>
                <button class="filter-chip" data-filter="disponible">‚úÖ Disponible</button>
            </div>

            <!-- Filtres avanc√©s -->
            <div class="advanced-filters">
                <h3 class="filters-title">üîß Filtres avanc√©s</h3>
                <div class="filters-grid">
                    <div class="filter-item">
                        <label>Prix maximum (‚Ç¨)</label>
                        <input type="number" id="filterMaxPrice" min="0" max="100" value="100" class="filter-input-number">
                        <span id="maxPriceValue">100‚Ç¨</span>
                    </div>
                    <div class="filter-item">
                        <label>Dur√©e maximum (heures)</label>
                        <input type="number" id="filterMaxDuration" min="0" max="10" value="10" step="0.5" class="filter-input-number">
                        <span id="maxDurationValue">10h</span>
                    </div>
                    <div class="filter-item">
                        <label>Note minimale</label>
                        <input type="number" id="filterMinRating" min="0" max="5" value="0" step="0.1" class="filter-input-number">
                        <span id="minRatingValue">0‚≠ê</span>
                    </div>
                </div>
            </div>

            <!-- Grille des trajets -->
            <div id="tripsGrid" class="trips-grid">
                <!-- Les trajets seront affich√©s ici par JavaScript -->
            </div>

            <!-- Message si aucun trajet -->
            <div id="noTrips" class="no-trips-message hidden">
                <div class="no-trips-icon">üöó</div>
                <h3>Aucun trajet trouv√©</h3>
                <p id="noTripsMessage">Essayez de modifier vos crit√®res de recherche</p>
                <div id="alternativeDate" class="alternative-date hidden">
                    <p><strong>üí° Suggestion :</strong> Un trajet est disponible le <span id="suggestedDate"></span></p>
                    <button class="btn-suggested-date" onclick="useSuggestedDate()">Voir ce trajet</button>
                </div>
            </div>
        </div>
    </section>

    <!-- Modal de r√©servation -->
    <div id="bookingModal" class="modal-overlay hidden">
        <div class="modal-content">
            <button class="modal-close" onclick="closeBookingModal()">√ó</button>
            <div class="modal-header">
                <h2>üí≥ Finaliser votre r√©servation</h2>
            </div>
            
            <div class="booking-summary" id="bookingSummary">
                <!-- R√©sum√© de la r√©servation -->
            </div>

            <div class="payment-section">
                <h3>M√©thode de paiement</h3>
                <div class="payment-options">
                    <label class="payment-option">
                        <input type="radio" name="payment" value="card" checked>
                        <div class="payment-option-content">
                            <span class="payment-icon">üí≥</span>
                            <div>
                                <div class="payment-name">Carte bancaire</div>
                                <div class="payment-desc">Visa, Mastercard, CB</div>
                            </div>
                        </div>
                    </label>
                    <label class="payment-option">
                        <input type="radio" name="payment" value="paypal">
                        <div class="payment-option-content">
                            <span class="payment-icon">üÖøÔ∏è</span>
                            <div>
                                <div class="payment-name">PayPal</div>
                                <div class="payment-desc">Payer avec PayPal</div>
                            </div>
                        </div>
                    </label>
                </div>
            </div>

            <div class="demo-notice">
                <span>‚ÑπÔ∏è</span>
                <span><strong>Mode d√©mo :</strong> Aucun paiement r√©el ne sera effectu√©</span>
            </div>

            <div class="modal-actions">
                <button class="btn-cancel" onclick="closeBookingModal()">Annuler</button>
                <button class="btn-confirm" onclick="confirmBooking()">Confirmer et payer</button>
            </div>
        </div>
    </div>

    <script src="js/userManager.js"></script>
    <script src="js/tripManager.js"></script>
    <script src="js/apiClient.js"></script>
    <script src="js/navbar.js"></script>
    <script>
        // Donn√©es des trajets avec 12 chauffeurs diff√©rents
        const demoTrips = [
            {
                id: 1,
                driver: 'Jean Dupont',
                driverPhoto: 'https://i.pravatar.cc/150?img=12',
                departure: 'Paris',
                destination: 'Lyon',
                date: '2025-10-20',
                time: '09:00',
                duration: '3h',
                price: 25,
                availableSeats: 3,
                totalSeats: 4,
                vehicle: 'Renault Zoe',
                vehicleType: '√âlectrique',
                rating: 4.8,
                description: 'Trajet confortable en voiture √©lectrique, r√©servation possible. Conduite douce et ponctuelle.'
            },
            {
                id: 2,
                driver: 'Marie Martin',
                driverPhoto: 'https://i.pravatar.cc/150?img=47',
                departure: 'Lyon',
                destination: 'Marseille',
                date: '2025-10-21',
                time: '14:30',
                duration: '2h30',
                price: 20,
                availableSeats: 2,
                totalSeats: 5,
                vehicle: 'Tesla Model 3',
                vehicleType: '√âlectrique',
                rating: 5.0,
                description: 'Conductrice exp√©riment√©e, voyage agr√©able garanti. Ambiance conviviale et musique douce.'
            },
            {
                id: 3,
                driver: 'Pierre Dubois',
                driverPhoto: 'https://i.pravatar.cc/150?img=33',
                departure: 'Paris',
                destination: 'Bordeaux',
                date: '2025-10-22',
                time: '08:00',
                duration: '4h',
                price: 30,
                availableSeats: 1,
                totalSeats: 4,
                vehicle: 'Peugeot e-208',
                vehicleType: '√âlectrique',
                rating: 4.5,
                description: 'D√©part t√¥t le matin, arriv√©e avant midi. Id√©al pour les rendez-vous professionnels. V√©hicule 100% √©lectrique.'
            },
            {
                id: 4,
                driver: 'Sophie Laurent',
                driverPhoto: 'https://i.pravatar.cc/150?img=45',
                departure: 'Bordeaux',
                destination: 'Paris',
                date: '2025-10-23',
                time: '15:00',
                duration: '4h',
                price: 28,
                availableSeats: 3,
                totalSeats: 5,
                vehicle: 'Nissan Leaf',
                vehicleType: '√âlectrique',
                rating: 4.9,
                description: 'V√©hicule √©lectrique, d√©part confortable de l\'apr√®s-midi. Pauses possibles.'
            },
            {
                id: 5,
                driver: 'Thomas Bernard',
                driverPhoto: 'https://i.pravatar.cc/150?img=15',
                departure: 'Lille',
                destination: 'Paris',
                date: '2025-10-24',
                time: '10:00',
                duration: '2h15',
                price: 18,
                availableSeats: 2,
                totalSeats: 4,
                vehicle: 'BMW i3',
                vehicleType: '√âlectrique',
                rating: 4.7,
                description: 'Trajet r√©gulier, ponctuel et professionnel. Confort premium garanti.'
            },
            {
                id: 6,
                driver: 'Camille Rousseau',
                driverPhoto: 'https://i.pravatar.cc/150?img=20',
                departure: 'Toulouse',
                destination: 'Montpellier',
                date: '2025-10-25',
                time: '11:30',
                duration: '2h45',
                price: 22,
                availableSeats: 4,
                totalSeats: 5,
                vehicle: 'Hyundai Kona Electric',
                vehicleType: '√âlectrique',
                rating: 4.9,
                description: 'Ambiance conviviale, musique douce, pauses possibles. Voyage d√©tendu.'
            },
            {
                id: 7,
                driver: 'Lucas Moreau',
                driverPhoto: 'https://i.pravatar.cc/150?img=27',
                departure: 'Nantes',
                destination: 'Rennes',
                date: '2025-10-26',
                time: '13:00',
                duration: '1h30',
                price: 15,
                availableSeats: 3,
                totalSeats: 5,
                vehicle: 'Volkswagen ID.3',
                vehicleType: '√âlectrique',
                rating: 4.6,
                description: 'Trajet court et √©conomique, id√©al pour un d√©placement rapide. Ponctuel.'
            },
            {
                id: 8,
                driver: 'Emma Petit',
                driverPhoto: 'https://i.pravatar.cc/150?img=9',
                departure: 'Strasbourg',
                destination: 'Nancy',
                date: '2025-10-27',
                time: '16:00',
                duration: '1h15',
                price: 12,
                availableSeats: 2,
                totalSeats: 4,
                vehicle: 'Renault Twingo E-Tech',
                vehicleType: '√âlectrique',
                rating: 5.0,
                description: 'Conductrice tr√®s sympa, trajet agr√©able garanti. Ambiance chaleureuse.'
            },
            {
                id: 9,
                driver: 'Antoine Girard',
                driverPhoto: 'https://i.pravatar.cc/150?img=51',
                departure: 'Nice',
                destination: 'Cannes',
                date: '2025-10-28',
                time: '09:30',
                duration: '45min',
                price: 10,
                availableSeats: 1,
                totalSeats: 3,
                vehicle: 'Smart EQ ForTwo',
                vehicleType: '√âlectrique',
                rating: 4.8,
                description: 'Petit v√©hicule √©cologique, parfait pour la C√¥te d\'Azur. Vue magnifique.'
            },
            {
                id: 10,
                driver: 'Julie Lefebvre',
                driverPhoto: 'https://i.pravatar.cc/150?img=32',
                departure: 'Lyon',
                destination: 'Grenoble',
                date: '2025-10-29',
                time: '12:00',
                duration: '1h',
                price: 14,
                availableSeats: 3,
                totalSeats: 5,
                vehicle: 'Peugeot e-208',
                vehicleType: '√âlectrique',
                rating: 4.7,
                description: 'Trajet montagneux, paysages magnifiques, conduite douce. D√©tente assur√©e.'
            },
            {
                id: 11,
                driver: 'Nicolas Simon',
                driverPhoto: 'https://i.pravatar.cc/150?img=68',
                departure: 'Paris',
                destination: 'Orl√©ans',
                date: '2025-10-30',
                time: '08:30',
                duration: '1h30',
                price: 16,
                availableSeats: 4,
                totalSeats: 5,
                vehicle: 'Citro√´n √´-C4',
                vehicleType: '√âlectrique',
                rating: 4.9,
                description: 'Confort optimal, v√©hicule r√©cent et bien entretenu. Service premium.'
            },
            {
                id: 12,
                driver: 'Am√©lie Durand',
                driverPhoto: 'https://i.pravatar.cc/150?img=5',
                departure: 'Bordeaux',
                destination: 'Toulouse',
                date: '2025-10-31',
                time: '14:00',
                duration: '2h30',
                price: 24,
                availableSeats: 2,
                totalSeats: 4,
                vehicle: 'Kia e-Niro',
                vehicleType: '√âlectrique',
                rating: 4.8,
                description: 'Autonomie longue, confort premium, voyage serein. Exp√©rience inoubliable.'
            }
        ];

        let availableTrips = [...demoTrips];
        let currentFilter = 'all';
        let currentBooking = null;

        // Charger les trajets utilisateurs
        if (typeof tripManager !== 'undefined') {
            tripManager.syncUserTrips();
            const userTrips = tripManager.getAllTrips();
            userTrips.forEach(trip => {
                availableTrips.push({
                    id: trip.id + 1000,
                    driver: trip.conducteur?.nom || 'Conducteur',
                    driverPhoto: trip.conducteur?.photo || `https://ui-avatars.com/api/?name=${encodeURIComponent(trip.conducteur?.nom || 'Conducteur')}&background=66BB6A&color=fff&size=150`,
                    departure: trip.trajet?.depart || '',
                    destination: trip.trajet?.destination || '',
                    date: trip.details?.date || '',
                    time: trip.details?.heureDepart || '',
                    duration: trip.trajet?.duree || '',
                    price: trip.details?.prix || 0,
                    availableSeats: trip.details?.placesDisponibles || 0,
                    totalSeats: trip.details?.vehicule?.places || 0,
                    vehicle: `${trip.details?.vehicule?.marque || ''} ${trip.details?.vehicule?.modele || ''}`.trim(),
                    vehicleType: trip.details?.vehicule?.type || '√âlectrique',
                    rating: trip.conducteur?.note || 5.0,
                    description: trip.description || 'Trajet disponible'
                });
            });
        }

        // Afficher les trajets
        function displayTrips(trips) {
            const grid = document.getElementById('tripsGrid');
            const noTrips = document.getElementById('noTrips');
            
            if (trips.length === 0) {
                grid.innerHTML = '';
                noTrips.classList.remove('hidden');
                document.getElementById('tripsCount').textContent = '0 trajet trouv√©';
                return;
            }

            noTrips.classList.add('hidden');
            document.getElementById('tripsCount').textContent = `${trips.length} trajet${trips.length > 1 ? 's' : ''} trouv√©${trips.length > 1 ? 's' : ''}`;
            
            grid.innerHTML = trips.map((trip, index) => {
                const dateObj = new Date(trip.date);
                const formattedDate = dateObj.toLocaleDateString('fr-FR', { 
                    weekday: 'long', 
                    day: 'numeric', 
                    month: 'long' 
                });
                
                const seatsClass = trip.availableSeats === 0 ? 'seats-none' : 
                                  trip.availableSeats <= 1 ? 'seats-low' : 'seats-ok';
                
                return `
                    <div class="trip-card" style="animation-delay: ${index * 0.1}s">
                        <div class="trip-card-header">
                            <div class="driver-info">
                                <img src="${trip.driverPhoto}" alt="${trip.driver}" class="driver-avatar" onerror="this.src='https://ui-avatars.com/api/?name=${encodeURIComponent(trip.driver)}&background=66BB6A&color=fff&size=150'">
                                <div>
                                    <h3 class="driver-name">${trip.driver}</h3>
                                    <div class="driver-rating">
                                        ${'‚≠ê'.repeat(Math.floor(trip.rating))}${trip.rating % 1 >= 0.5 ? '‚ú®' : ''}
                                        <span>${trip.rating}</span>
                                    </div>
                                </div>
                            </div>
                            <div class="trip-badge ${seatsClass}">
                                ${trip.availableSeats} place${trip.availableSeats > 1 ? 's' : ''}
                            </div>
                        </div>
                        
                        <div class="trip-route">
                            <div class="route-start">
                                <div class="route-dot"></div>
                                <div>
                                    <div class="route-city">${trip.departure}</div>
                                    <div class="route-time">${trip.time}</div>
                                </div>
                            </div>
                            <div class="route-line">
                                <div class="route-duration">${trip.duration}</div>
                            </div>
                            <div class="route-end">
                                <div class="route-dot"></div>
                                <div>
                                    <div class="route-city">${trip.destination}</div>
                                    <div class="route-date">${formattedDate}</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="trip-details">
                            <div class="trip-vehicle">
                                <span>üöó</span>
                                <span>${trip.vehicle}</span>
                                <span class="vehicle-type">‚ö°</span>
                            </div>
                            <p class="trip-description">${trip.description}</p>
                        </div>
                        
                        <div class="trip-footer">
                            <div class="trip-price">
                                <span class="price-amount">${trip.price}‚Ç¨</span>
                                <span class="price-label">par personne</span>
                            </div>
                            <div class="trip-actions">
                                <button class="btn-detail" onclick="showTripDetails(${trip.id})">üìã D√©tail</button>
                                <button class="btn-contact" onclick="contactDriver(${trip.id})">üìû Contacter</button>
                                <button class="btn-book ${trip.availableSeats === 0 ? 'disabled' : ''}" 
                                        onclick="bookTrip(${trip.id})" 
                                        ${trip.availableSeats === 0 ? 'disabled' : ''}>
                                    ‚úã R√©server
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Trouver la date la plus proche
        function findClosestDate(depart, date) {
            if (!depart || !date) return null;
            
            const requestedDate = new Date(date);
            const tripsForCity = availableTrips.filter(t => 
                t.departure.toLowerCase().includes(depart.toLowerCase()) && 
                t.availableSeats > 0
            );
            
            if (tripsForCity.length === 0) return null;
            
            // Trier par proximit√© de date
            tripsForCity.sort((a, b) => {
                const dateA = new Date(a.date);
                const dateB = new Date(b.date);
                const diffA = Math.abs(dateA - requestedDate);
                const diffB = Math.abs(dateB - requestedDate);
                return diffA - diffB;
            });
            
            return tripsForCity[0].date;
        }

        // Convertir dur√©e en heures (ex: "3h" -> 3, "2h30" -> 2.5)
        function parseDuration(duration) {
            const match = duration.match(/(\d+)h(?:\s*(\d+)min)?/);
            if (!match) return 0;
            const hours = parseInt(match[1]) || 0;
            const minutes = parseInt(match[2]) || 0;
            return hours + (minutes / 60);
        }

        // Filtrer les trajets
        function filterTrips() {
            let filtered = availableTrips;
            
            // Filtre par type
            if (currentFilter === 'electrique') {
                filtered = filtered.filter(t => t.vehicleType === '√âlectrique');
            } else if (currentFilter === 'disponible') {
                filtered = filtered.filter(t => t.availableSeats > 0);
            }
            
            // Filtre par recherche
            const depart = document.getElementById('depart').value.toLowerCase();
            const destination = document.getElementById('destination').value.toLowerCase();
            const date = document.getElementById('date').value;
            
            if (depart) {
                filtered = filtered.filter(t => t.departure.toLowerCase().includes(depart));
            }
            if (destination) {
                filtered = filtered.filter(t => t.destination.toLowerCase().includes(destination));
            }
            if (date) {
                filtered = filtered.filter(t => t.date === date);
            }
            
            // Filtres avanc√©s
            const maxPrice = parseFloat(document.getElementById('filterMaxPrice').value) || 100;
            const maxDuration = parseFloat(document.getElementById('filterMaxDuration').value) || 10;
            const minRating = parseFloat(document.getElementById('filterMinRating').value) || 0;
            
            filtered = filtered.filter(t => {
                if (t.price > maxPrice) return false;
                if (parseDuration(t.duration) > maxDuration) return false;
                if (t.rating < minRating) return false;
                return true;
            });
            
            // Si aucun r√©sultat et qu'une date est demand√©e, proposer date plus proche
            if (filtered.length === 0 && date && depart) {
                const closestDate = findClosestDate(depart, date);
                if (closestDate) {
                    const dateObj = new Date(closestDate);
                    const formattedDate = dateObj.toLocaleDateString('fr-FR', { 
                        weekday: 'long', 
                        day: 'numeric', 
                        month: 'long' 
                    });
                    document.getElementById('suggestedDate').textContent = formattedDate;
                    document.getElementById('alternativeDate').classList.remove('hidden');
                    window.suggestedDateValue = closestDate;
                } else {
                    document.getElementById('alternativeDate').classList.add('hidden');
                }
            } else {
                document.getElementById('alternativeDate').classList.add('hidden');
            }
            
            displayTrips(filtered);
        }

        function useSuggestedDate() {
            if (window.suggestedDateValue) {
                document.getElementById('date').value = window.suggestedDateValue;
                filterTrips();
            }
        }

        // Gestionnaires d'√©v√©nements
        document.getElementById('searchForm').addEventListener('submit', (e) => {
            e.preventDefault();
            filterTrips();
        });

        document.getElementById('resetButton').addEventListener('click', () => {
            document.getElementById('depart').value = '';
            document.getElementById('destination').value = '';
            document.getElementById('date').value = '';
            currentFilter = 'all';
            document.querySelectorAll('.filter-chip').forEach(chip => {
                chip.classList.remove('active');
            });
            document.querySelector('.filter-chip[data-filter="all"]').classList.add('active');
            displayTrips(availableTrips);
        });

        document.querySelectorAll('.filter-chip').forEach(chip => {
            chip.addEventListener('click', () => {
                document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
                chip.classList.add('active');
                currentFilter = chip.dataset.filter;
                filterTrips();
            });
        });

        // Gestionnaires pour les filtres avanc√©s
        document.getElementById('filterMaxPrice').addEventListener('input', function() {
            document.getElementById('maxPriceValue').textContent = this.value + '‚Ç¨';
            filterTrips();
        });

        document.getElementById('filterMaxDuration').addEventListener('input', function() {
            document.getElementById('maxDurationValue').textContent = this.value + 'h';
            filterTrips();
        });

        document.getElementById('filterMinRating').addEventListener('input', function() {
            document.getElementById('minRatingValue').textContent = this.value + '‚≠ê';
            filterTrips();
        });

        // Fonction pour afficher les d√©tails d'un trajet
        function showTripDetails(tripId) {
            const trip = availableTrips.find(t => t.id === tripId);
            if (!trip) return;
            
            window.location.href = `trip-details.html?id=${tripId}`;
        }

        // Fonctions de r√©servation
        function contactDriver(tripId) {
            const trip = availableTrips.find(t => t.id === tripId);
            if (trip) {
                window.location.href = `contact.html?trip=${tripId}&driver=${encodeURIComponent(trip.driver)}`;
            }
        }

        function bookTrip(tripId) {
            if (!userManager.isLoggedIn()) {
                alert('Vous devez √™tre connect√© pour r√©server un covoiturage.');
                window.location.href = 'login.html';
                return;
            }

            const trip = availableTrips.find(t => t.id === tripId);
            if (trip && trip.availableSeats > 0) {
                currentBooking = trip;
                showBookingModal();
            }
        }

        function showBookingModal() {
            if (!currentBooking) return;
            
            const dateObj = new Date(currentBooking.date);
            const formattedDate = dateObj.toLocaleDateString('fr-FR', { 
                weekday: 'long', 
                day: 'numeric', 
                month: 'long',
                year: 'numeric'
            });
            
            document.getElementById('bookingSummary').innerHTML = `
                <div class="summary-item">
                    <span>Trajet</span>
                    <strong>${currentBooking.departure} ‚Üí ${currentBooking.destination}</strong>
                </div>
                <div class="summary-item">
                    <span>Chauffeur</span>
                    <strong>${currentBooking.driver}</strong>
                </div>
                <div class="summary-item">
                    <span>Date</span>
                    <strong>${formattedDate} √† ${currentBooking.time}</strong>
                </div>
                <div class="summary-item">
                    <span>V√©hicule</span>
                    <strong>${currentBooking.vehicle}</strong>
                </div>
                <div class="summary-total">
                    <span>Total</span>
                    <strong>${currentBooking.price}‚Ç¨</strong>
                </div>
            `;
            
            document.getElementById('bookingModal').classList.remove('hidden');
        }

        function closeBookingModal() {
            document.getElementById('bookingModal').classList.add('hidden');
            currentBooking = null;
        }

        // Double confirmation pour la r√©servation
        let firstConfirmation = false;

        function confirmBooking() {
            if (!currentBooking) return;
            
            const user = userManager.getCurrentUser();
            
            // V√©rifier les cr√©dits
            const userCredits = user.credits || 20;
            const totalCost = currentBooking.price + 2; // Prix + 2 cr√©dits plateforme
            
            if (userCredits < totalCost) {
                alert(`‚ùå Cr√©dits insuffisants !\n\nVous avez : ${userCredits} cr√©dits\nN√©cessaire : ${totalCost} cr√©dits (${currentBooking.price}‚Ç¨ + 2 cr√©dits plateforme)\n\nVeuillez recharger vos cr√©dits.`);
                closeBookingModal();
                return;
            }
            
            // Premi√®re confirmation
            if (!firstConfirmation) {
                firstConfirmation = true;
                const paymentMethod = document.querySelector('input[name="payment"]:checked').value;
                const confirmMsg = `‚ö†Ô∏è CONFIRMATION REQUISE\n\nVous allez utiliser ${totalCost} cr√©dits pour ce trajet :\n- ${currentBooking.price}‚Ç¨ pour le trajet\n- 2 cr√©dits pour la plateforme\n\nVotre solde apr√®s : ${userCredits - totalCost} cr√©dits\n\n√ätes-vous s√ªr de vouloir confirmer ?`;
                
                if (!confirm(confirmMsg)) {
                    firstConfirmation = false;
                    return;
                }
                
                // Deuxi√®me confirmation
                if (!confirm('üîí DOUBLE CONFIRMATION\n\nConfirmez une derni√®re fois votre r√©servation.')) {
                    firstConfirmation = false;
                    return;
                }
                
                // Cr√©er la r√©servation
                const reservation = {
                    id: Date.now(),
                    tripId: currentBooking.id,
                    userId: user.id,
                    driver: currentBooking.driver,
                    departure: currentBooking.departure,
                    destination: currentBooking.destination,
                    date: currentBooking.date,
                    price: currentBooking.price,
                    platformFee: 2,
                    totalCost: totalCost,
                    paymentMethod: paymentMethod,
                    status: 'confirmed',
                    createdAt: new Date().toISOString()
                };

                // Sauvegarder la r√©servation
                let reservations = JSON.parse(localStorage.getItem('ecoride_reservations') || '[]');
                reservations.push(reservation);
                localStorage.setItem('ecoride_reservations', JSON.stringify(reservations));

                // Mettre √† jour les cr√©dits
                user.credits = userCredits - totalCost;
                userManager.updateUser(user);
                localStorage.setItem('ecoride_current_user', JSON.stringify(user));

                // Mettre √† jour les places disponibles
                const trip = availableTrips.find(t => t.id === currentBooking.id);
                if (trip) {
                    trip.availableSeats--;
                }

                closeBookingModal();
                firstConfirmation = false;
                
                alert(`‚úÖ R√©servation confirm√©e !\n\nTrajet: ${currentBooking.departure} ‚Üí ${currentBooking.destination}\nChauffeur: ${currentBooking.driver}\nPrix: ${currentBooking.price}‚Ç¨\nFrais plateforme: 2 cr√©dits\nTotal: ${totalCost} cr√©dits\nNouveau solde: ${user.credits} cr√©dits\n\nMerci pour votre confiance !`);
                window.location.href = 'dashboard.html';
            }
        }

        // Fermer modal en cliquant en dehors
        document.getElementById('bookingModal').addEventListener('click', (e) => {
            if (e.target.id === 'bookingModal') {
                closeBookingModal();
            }
        });

        // Initialisation
        displayTrips(availableTrips);
        
        // Exporter les fonctions
        window.contactDriver = contactDriver;
        window.bookTrip = bookTrip;
        window.closeBookingModal = closeBookingModal;
        window.confirmBooking = confirmBooking;
    </script>
</body>
</html>
