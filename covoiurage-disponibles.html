<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="css/home.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <title>EcoRide - Covoiturages Disponibles</title>
</head>

<body>
    <nav class="navbar">
        <div class="logo">
            <img src="images/EcoRide üåø.png" alt="Logo">
        </div>
        <ul class="nav-links">
            <li><a href="home.html">Accueil</a></li>
            <li><a href="covoiurage-disponibles.html">Acc√®s aux covoiturages</a></li>
            <li><a href="contact.html">Contact</a></li>
            <li><a href="login.html">Connexion</a></li>
            <li><a href="register.html">Cr√©er un compte</a></li>
        </ul>
    </nav>

    <main class="min-h-screen bg-gray-50 py-8">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <!-- En-t√™te -->
            <div class="text-center mb-8">
                <h1 class="text-4xl font-bold text-green-700 mb-4">üöó Covoiturages Disponibles</h1>
                <p class="text-gray-600 text-lg">Trouvez le covoiturage qui vous convient parmi nos offres disponibles</p>
            </div>

            <!-- Filtres de recherche -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-8">
                <h2 class="text-xl font-bold mb-4">üîç Rechercher un covoiturage</h2>
                <form id="filterForm" class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <input type="text" id="filterDepart" placeholder="Ville de d√©part" 
                           class="border border-gray-300 rounded-md px-4 py-2 focus:outline-none focus:ring-2 focus:ring-green-500">
                    <input type="text" id="filterDestination" placeholder="Ville de destination" 
                           class="border border-gray-300 rounded-md px-4 py-2 focus:outline-none focus:ring-2 focus:ring-green-500">
                    <input type="date" id="filterDate" 
                           class="border border-gray-300 rounded-md px-4 py-2 focus:outline-none focus:ring-2 focus:ring-green-500">
                    <button type="submit" class="bg-green-600 text-white font-bold py-2 px-4 rounded-md hover:bg-green-700 transition">
                        Rechercher
                    </button>
                </form>
                <button id="resetFilters" class="mt-4 text-green-600 hover:text-green-700 font-medium">
                    R√©initialiser les filtres
                </button>
            </div>

            <!-- Liste des covoiturages -->
            <div id="tripsList" class="space-y-6">
                <!-- Les covoiturages seront affich√©s ici -->
            </div>

            <!-- Message si aucun covoiturage -->
            <div id="noTripsMessage" class="hidden text-center py-12">
                <div class="text-6xl mb-4">üöó</div>
                <h3 class="text-2xl font-bold text-gray-700 mb-2">Aucun covoiturage disponible</h3>
                <p class="text-gray-600">Essayez de modifier vos crit√®res de recherche</p>
            </div>
        </div>
    </main>

    <!-- Modal de paiement -->
    <div id="paymentModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <h3 class="text-lg font-medium text-gray-900 mb-4">üí≥ Paiement</h3>
                
                <!-- D√©tails de la r√©servation -->
                <div class="bg-gray-50 rounded-lg p-4 mb-4">
                    <div class="flex justify-between mb-2">
                        <span class="text-gray-600">Trajet:</span>
                        <span class="font-semibold" id="paymentTripDetails"></span>
                    </div>
                    <div class="flex justify-between mb-2">
                        <span class="text-gray-600">Chauffeur:</span>
                        <span class="font-semibold" id="paymentDriver"></span>
                    </div>
                    <div class="flex justify-between border-t pt-2">
                        <span class="text-gray-900 font-bold">Total:</span>
                        <span class="text-2xl font-bold text-green-600" id="paymentAmount"></span>
                    </div>
                </div>

                <!-- M√©thode de paiement -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Choisir votre m√©thode de paiement</label>
                    
                    <div class="space-y-2">
                        <label class="flex items-center p-3 border-2 border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50">
                            <input type="radio" name="paymentMethod" value="card" class="h-4 w-4 text-green-600" checked>
                            <span class="ml-3 text-gray-700">
                                <span class="font-medium">üí≥ Carte bancaire</span>
                                <p class="text-xs text-gray-500">Visa, Mastercard, etc.</p>
                            </span>
                        </label>
                        
                        <label class="flex items-center p-3 border-2 border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50">
                            <input type="radio" name="paymentMethod" value="paypal" class="h-4 w-4 text-green-600">
                            <span class="ml-3 text-gray-700">
                                <span class="font-medium">üÖøÔ∏è PayPal</span>
                                <p class="text-xs text-gray-500">Payer avec votre compte PayPal</p>
                            </span>
                        </label>
                    </div>
                </div>

                <!-- Message de simulation -->
                <div class="bg-blue-50 border border-blue-200 text-blue-800 p-3 rounded-lg mb-4 text-sm">
                    ‚ÑπÔ∏è <strong>Mode d√©mo:</strong> Ceci est une simulation de paiement pour le projet scolaire. Aucun vrai paiement ne sera effectu√©.
                </div>

                <!-- Boutons -->
                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="hidePaymentModal()" class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600">
                        Annuler
                    </button>
                    <button type="button" onclick="processPayment()" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700">
                        Payer et r√©server
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="js/userManager.js"></script>
    <script src="js/tripManager.js"></script>
    <script src="js/navbar.js"></script>
    <script>
        // Covoiturages de d√©monstration
        const demoTrips = [
            {
                id: 1,
                driver: 'Jean Dupont',
                driverPhoto: 'images/dupont.jpeg',
                departure: 'Paris',
                destination: 'Lyon',
                date: '2025-10-20',
                time: '09:00',
                duration: '3h',
                price: 25,
                availableSeats: 3,
                totalSeats: 4,
                vehicle: 'Renault Zoe',
                vehicleType: '√âlectrique',
                rating: 4.8,
                description: 'Trajet confortable en voiture √©lectrique, r√©servation possible.'
            },
            {
                id: 2,
                driver: 'Marie Martin',
                driverPhoto: 'images/dupont.jpeg',
                departure: 'Lyon',
                destination: 'Marseille',
                date: '2025-10-21',
                time: '14:30',
                duration: '2h30',
                price: 20,
                availableSeats: 2,
                totalSeats: 5,
                vehicle: 'Tesla Model 3',
                vehicleType: '√âlectrique',
                rating: 5.0,
                description: 'Conducteur exp√©riment√©, voyage agr√©able garanti.'
            },
            {
                id: 3,
                driver: 'Pierre Dubois',
                driverPhoto: 'images/dupont.jpeg',
                departure: 'Paris',
                destination: 'Bordeaux',
                date: '2025-10-22',
                time: '08:00',
                duration: '4h',
                price: 30,
                availableSeats: 1,
                totalSeats: 4,
                vehicle: 'Peugeot 208',
                vehicleType: 'Essence',
                rating: 4.5,
                description: 'D√©part t√¥t le matin, arriv√©e avant midi.'
            },
            {
                id: 4,
                driver: 'Sophie Laurent',
                driverPhoto: 'images/dupont.jpeg',
                departure: 'Bordeaux',
                destination: 'Paris',
                date: '2025-10-23',
                time: '15:00',
                duration: '4h',
                price: 28,
                availableSeats: 3,
                totalSeats: 5,
                vehicle: 'Nissan Leaf',
                vehicleType: '√âlectrique',
                rating: 4.9,
                description: 'V√©hicule √©lectrique, d√©part confortable de l\'apr√®s-midi.'
            }
        ];

        // Fonction pour convertir un covoiturage du format tripManager au format de cette page
        function convertTripFormat(trip) {
            return {
                id: trip.id,
                driver: trip.conducteur?.nom || 'Conducteur inconnu',
                driverPhoto: trip.conducteur?.photo || 'images/dupont.jpeg',
                departure: trip.trajet?.depart || '',
                destination: trip.trajet?.destination || '',
                date: trip.details?.date || '',
                time: trip.details?.heureDepart || '',
                duration: trip.trajet?.duree || '',
                price: trip.details?.prix || 0,
                availableSeats: trip.details?.placesDisponibles || 0,
                totalSeats: trip.details?.vehicule?.places || 0,
                vehicle: `${trip.details?.vehicule?.marque || ''} ${trip.details?.vehicule?.modele || ''}`.trim(),
                vehicleType: trip.details?.vehicule?.type || 'Inconnu',
                rating: trip.conducteur?.note || 5.0,
                description: trip.description || `Trajet de ${trip.trajet?.depart} vers ${trip.trajet?.destination}`
            };
        }

        // Charger tous les covoiturages (d√©mo + utilisateurs)
        let availableTrips = [...demoTrips];
        
        // Charger les covoiturages cr√©√©s par les utilisateurs
        if (typeof tripManager !== 'undefined') {
            tripManager.syncUserTrips();
            const userTrips = tripManager.getAllTrips();
            const convertedUserTrips = userTrips.map(trip => convertTripFormat(trip));
            availableTrips = [...demoTrips, ...convertedUserTrips];
            console.log('Total covoiturages charg√©s:', availableTrips.length, '(d√©mo:', demoTrips.length, ', utilisateurs:', convertedUserTrips.length, ')');
        }

        // Fonction pour trier les covoiturages par date (du plus r√©cent au plus ancien)
        function sortTripsByDate(trips) {
            return trips.sort((a, b) => {
                const dateA = new Date(a.date + 'T' + (a.time || '00:00')).getTime();
                const dateB = new Date(b.date + 'T' + (b.time || '00:00')).getTime();
                return dateB - dateA; // Plus r√©cent en premier
            });
        }

        // Trier les covoiturages par date au chargement
        availableTrips = sortTripsByDate(availableTrips);

        // Fonction pour afficher les covoiturages
        function displayTrips(trips) {
            const tripsList = document.getElementById('tripsList');
            const noTripsMessage = document.getElementById('noTripsMessage');

            if (trips.length === 0) {
                tripsList.innerHTML = '';
                noTripsMessage.classList.remove('hidden');
                return;
            }

            noTripsMessage.classList.add('hidden');
            tripsList.innerHTML = '';

            trips.forEach(trip => {
                const tripCard = document.createElement('div');
                tripCard.className = 'bg-white rounded-lg shadow-md p-6 hover:shadow-lg transition-shadow';
                tripCard.innerHTML = `
                    <div class="flex flex-col lg:flex-row justify-between">
                        <div class="flex-1">
                            <div class="flex items-center space-x-4 mb-4">
                                <img src="${trip.driverPhoto}" alt="${trip.driver}" class="w-16 h-16 rounded-full">
                                <div>
                                    <h3 class="text-xl font-bold text-gray-900">${trip.driver}</h3>
                                    <p class="text-yellow-500 text-lg">‚≠ê ${trip.rating}</p>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                <div>
                                    <p class="text-gray-600 mb-1"><strong>D√©part :</strong></p>
                                    <p class="text-green-700 font-semibold">${trip.departure}</p>
                                </div>
                                <div>
                                    <p class="text-gray-600 mb-1"><strong>Destination :</strong></p>
                                    <p class="text-green-700 font-semibold">${trip.destination}</p>
                                </div>
                                <div>
                                    <p class="text-gray-600 mb-1"><strong>Date :</strong></p>
                                    <p>${new Date(trip.date).toLocaleDateString('fr-FR')}</p>
                                </div>
                                <div>
                                    <p class="text-gray-600 mb-1"><strong>Heure :</strong></p>
                                    <p>${trip.time} (${trip.duration})</p>
                                </div>
                                <div>
                                    <p class="text-gray-600 mb-1"><strong>V√©hicule :</strong></p>
                                    <p>${trip.vehicle} <span class="text-green-600">üå± ${trip.vehicleType}</span></p>
                                </div>
                                <div>
                                    <p class="text-gray-600 mb-1"><strong>Places :</strong></p>
                                    <p class="font-semibold ${trip.availableSeats === 0 ? 'text-red-600' : 'text-green-600'}">
                                        ${trip.availableSeats} / ${trip.totalSeats} disponible${trip.availableSeats > 1 ? 's' : ''}
                                    </p>
                                </div>
                            </div>
                            
                            <p class="text-gray-700 mb-4">${trip.description}</p>
                        </div>
                        
                        <div class="lg:ml-6 lg:border-l lg:pl-6 border-gray-200">
                            <div class="text-center mb-4">
                                <p class="text-3xl font-bold text-green-600">${trip.price}‚Ç¨</p>
                                <p class="text-gray-600 text-sm">par personne</p>
                            </div>
                            
                            <button onclick="contactDriver(${trip.id})" 
                                    class="w-full bg-green-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-green-700 transition mb-3">
                                üìû Contacter le chauffeur
                            </button>
                            
                            <button onclick="bookTrip(${trip.id})" 
                                    ${trip.availableSeats === 0 ? 'disabled' : ''}
                                    class="w-full bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 transition disabled:bg-gray-400 disabled:cursor-not-allowed">
                                ‚úã R√©server
                            </button>
                        </div>
                    </div>
                `;
                tripsList.appendChild(tripCard);
            });
        }

        // Fonction pour contacter le chauffeur
        function contactDriver(tripId) {
            const trip = availableTrips.find(t => t.id === tripId);
            if (trip) {
                window.location.href = `contact.html?trip=${tripId}&driver=${encodeURIComponent(trip.driver)}`;
            }
        }

        // Variable globale pour stocker le voyage en cours de r√©servation
        let currentBookingTrip = null;

        // Fonction pour r√©server un covoiturage
        function bookTrip(tripId) {
            if (!userManager.isLoggedIn()) {
                alert('Vous devez √™tre connect√© pour r√©server un covoiturage.');
                window.location.href = 'login.html';
                return;
            }

            const trip = availableTrips.find(t => t.id === tripId);
            if (trip && trip.availableSeats > 0) {
                currentBookingTrip = trip;
                showPaymentModal();
            }
        }

        // Fonction pour afficher le modal de paiement
        function showPaymentModal() {
            if (!currentBookingTrip) return;

            document.getElementById('paymentTripDetails').textContent = 
                `${currentBookingTrip.departure} ‚Üí ${currentBookingTrip.destination}`;
            document.getElementById('paymentDriver').textContent = currentBookingTrip.driver;
            document.getElementById('paymentAmount').textContent = `${currentBookingTrip.price}‚Ç¨`;

            document.getElementById('paymentModal').classList.remove('hidden');
        }

        // Fonction pour cacher le modal de paiement
        function hidePaymentModal() {
            document.getElementById('paymentModal').classList.add('hidden');
            currentBookingTrip = null;
        }

        // Fonction pour traiter le paiement
        function processPayment() {
            if (!currentBookingTrip) return;

            const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked').value;
            
            // Simuler le processus de paiement
            setTimeout(() => {
                // Cr√©er la r√©servation dans le syst√®me
                const user = userManager.getCurrentUser();
                const reservation = {
                    id: Date.now(),
                    tripId: currentBookingTrip.id,
                    userId: user.id,
                    driver: currentBookingTrip.driver,
                    departure: currentBookingTrip.departure,
                    destination: currentBookingTrip.destination,
                    date: currentBookingTrip.date,
                    price: currentBookingTrip.price,
                    paymentMethod: paymentMethod,
                    status: 'confirmed',
                    createdAt: new Date().toISOString()
                };

                // Sauvegarder la r√©servation
                saveReservation(reservation);

                // Cacher le modal
                hidePaymentModal();

                // Afficher le message de succ√®s
                alert(`‚úÖ R√©servation confirm√©e !\n\nTrajet: ${currentBookingTrip.departure} ‚Üí ${currentBookingTrip.destination}\nChauffeur: ${currentBookingTrip.driver}\nPrix: ${currentBookingTrip.price}‚Ç¨\n\nMerci pour votre confiance !`);

                // Rediriger vers le dashboard
                window.location.href = 'dashboard.html';
            }, 500);
        }

        // Fonction pour sauvegarder une r√©servation
        function saveReservation(reservation) {
            let reservations = JSON.parse(localStorage.getItem('ecoride_reservations') || '[]');
            reservations.push(reservation);
            localStorage.setItem('ecoride_reservations', JSON.stringify(reservations));
        }

        // Gestion des filtres
        document.getElementById('filterForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const depart = document.getElementById('filterDepart').value.toLowerCase();
            const destination = document.getElementById('filterDestination').value.toLowerCase();
            const date = document.getElementById('filterDate').value;

            let filteredTrips = availableTrips;

            if (depart) {
                filteredTrips = filteredTrips.filter(t => t.departure.toLowerCase().includes(depart));
            }

            if (destination) {
                filteredTrips = filteredTrips.filter(t => t.destination.toLowerCase().includes(destination));
            }

            if (date) {
                filteredTrips = filteredTrips.filter(t => t.date === date);
            }

            // Trier les r√©sultats filtr√©s par date (du plus r√©cent au plus ancien)
            filteredTrips = sortTripsByDate(filteredTrips);
            displayTrips(filteredTrips);
        });

        // Reset filters
        document.getElementById('resetFilters').addEventListener('click', function() {
            document.getElementById('filterForm').reset();
            displayTrips(availableTrips);
        });

        // Initialisation
        displayTrips(availableTrips);

        // Exporter les fonctions
        window.contactDriver = contactDriver;
        window.bookTrip = bookTrip;
        window.showPaymentModal = showPaymentModal;
        window.hidePaymentModal = hidePaymentModal;
        window.processPayment = processPayment;
    </script>
</body>
</html>
